using DutyMechanic.Helpers;
using ff14bot;
using ff14bot.Managers;
using ff14bot.Objects;
using System.Collections.Generic;
using System.Linq;

namespace DutyMechanic.Extensions;

/// <summary>
/// Various extension methods.
/// </summary>
internal static class Extensions
{
    /// <summary>
    /// Checks if any nearby <see cref="BattleCharacter"/> is casting any spell ID in this collection.
    /// </summary>
    /// <param name="spellCastIds">Spell IDs to check against.</param>
    /// <returns><see langword="true"/> if any given spell is being casted.</returns>
    public static bool IsCasting(this HashSet<uint> spellCastIds)
    {
        return GameObjectManager.GetObjectsOfType<BattleCharacter>(true, false)
                .Where(bc => spellCastIds.Contains(bc.CastingSpellId))
                .Where(bc => !(bool)PartyManager.AllMembers?.Any(pm => pm.ObjectId == bc.ObjectId))
                .Any();
    }

    /// <summary>
    /// Disables SideStep around certain boss-related monsters.
    /// </summary>
    /// <param name="bossIds">Boss monster IDs.</param>
    /// <param name="ignoreIds">IDs to filter out of the base list.</param>
    public static void ToggleSideStep(this HashSet<uint> bossIds, uint[] ignoreIds = null)
    {
        if (Core.Target == null)
        {
            return;
        }

        PluginContainer sidestepPlugin = PluginHelpers.GetSideStepPlugin();

        if (sidestepPlugin != null)
        {
            HashSet<uint> filteredIds = new(bossIds.Where(id => ignoreIds == null || !ignoreIds.Contains(id)));

            bool isBoss = ignoreIds != null
            ? GameObjectManager.GetObjectsOfType<BattleCharacter>(true, false)
                               .Any(obj => obj.Distance() < 50 && filteredIds.Contains(obj.NpcId))
            : GameObjectManager.GetObjectsOfType<BattleCharacter>(true, false)
                               .Any(obj => obj.Distance() < 50 && bossIds.Contains(obj.NpcId));

            sidestepPlugin.Enabled = !isBoss;
        }
    }
}
